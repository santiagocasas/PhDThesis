\chapter{The non-linear evolution of matter perturbations} % Main chapter title

\label{Nonlin} % For referencing the chapter elsewhere, use \ref{Chapter1} 

%----------------------------------------------------------------------------------------


%----------------------------------------------------------------------------------------

\subsubsection{The non-linear standard equations in Fourier space}

For studying large scale structure formation we will treat the Dark
Matter distribution as a perfect fluid coupled to gravity, described
by the continuity, Euler and Poisson's equations. This amounts to
neglecting higher moments of the Vlasov equation, such as the stress
tensor and velocity dispersions \cite{bernardeau_large-scale_2001}.
This is equivalent to the single stream approximation and is one of
the main limitations of Eulerian perturbation theory, since the theory
breaks down as soon as shell crossing and multi-streaming start being
important.

In the Einstein frame we have the following fluid equations for a
general modification of gravity or a coupling to other scalar degrees
of freedom \cite{pietroni_flowing_2008}:

\begin{align}
\frac{\partial\delta_{c}}{\partial\tau} & +\nabla\cdot\left[\left(1+\delta_{c}\right)\vk v\right]=0\label{eq:continuity}\\
\frac{\partial\vk v}{\partial\tau} & +\curH(\vk v+\left[\mathcal{A}\vk v\right])+\left(\vk v\cdot\nabla\right)\vk v=-\nabla\Psi\label{eq:euler}\\
\nabla^{2}\Psi & =\frac{3}{2}\curH^{2}\Omega_{c}(\tau)\left(\delta_{c}+\left[\mathcal{B}\delta_{c}\right]\right)\label{eq:poisson}
\end{align}
Here $\tau$ is the conformal time,$\delta_{c}(\vk x,\tau)$ and $\vk v(\vk x,\tau)$
are respectively the matter density contrast and the peculiar velocity,
$\curH=\d\log a/\d\tau$ is the conformal Hubble parameter, $\Psi(\vk x,\tau)$
the gravitational potential and the functions$\mathcal{A}(\vk x,\tau)$
and $\mathcal{B}(\vk x,\tau)$ are general functions of space and
time that parametrize different cosmologies, when particles' geodesics
are modified, i.e. the Poisson and Euler equations. This can happen
due to couplings with a scalar field or more general modifications
of gravity (MG), such as any Horndeski theory or massive bigravity
theories \cite{amendola_observables_2012}. However, in the Jordan
frame (where most MG theories are formulated) the Euler equation is
not modified and there is only a space-time dependent modification
to the Poisson equation, which can be expressed as in eqn. \ref{eq:Yfunc}
once we go to Fourier space. In this work $\Omega_{m}(\tau)$$\equiv$$\Omega_{c}(\tau)$
are the time functions representing the cold dark matter (CDM) or
the full matter density of the Universe, since we are not considering
baryonic matter nor non-universal couplings.

The last term in the left hand side of eqns. \ref{eq:continuity}
and \ref{eq:euler} is what causes the nonliniearities in the evolution
of the fluid. This can be seen in Fourier space as a mode-mode coupling
or expressed as a nonlocality of the equations. This is the property
that describes how a specific Fourier mode is able to depend on another
mode at a different wave vector. We now go to Fourier space and will
express equations \ref{eq:continuity}-\ref{eq:poisson} in a compact
form introduced by \cite{scoccimarro_new_2000}.

The density is a scalar degree of freedom and the velocity can be
decomposed such that:

\begin{equation}
\vk v(\vk k)=\vk v_{\theta}(\vk k)+\vk{v{}_{\omega}}(\vk k)
\end{equation}
where: 
\begin{align*}
\vk k\cdot\vk{v_{\omega}}(\vk k) & =0\\
\vk k\times\vk{v_{\theta}}(\vk k) & =0
\end{align*}


According to linear theory the vorticity component $\vk{v{}_{\omega}}(\vk k)$
decays with the expansion of the Universe as $a^{-1}$, so if we assume
non-vortical initial conditions, we can neglect this term and look
only at the velocity divergence $\theta=i\vk k\cdot\vk v$, which
is now a scalar function. Inverting this last relation to get: $\vk v=-\frac{i\vk k}{k^{2}}\theta$,
allows us to perform the Fourier transforms explicitly:

\begin{align*}
\mathit{FT}\left\{ \nabla\cdot(\delta_{m}\vk v)\right\}  & =+i\vk k\int\d^{3}q\d^{3}p\delta_{D}(\vk p+\vk q-\vk k)\frac{-i\vk p}{p^{2}}\delta_{m}\ppt q\theta\ppt p\\
 & =\int\d^{3}q\d^{3}p\delta_{D}(\vk k-\vk p-\vk q)\underbrace{\frac{\left(\vk p+\vk q\right)\cdot\vk p}{p^{2}}}_{\alpha(\vk p,\vk q)}\delta_{m}\ppt q\theta\ppt p
\end{align*}


\begin{align*}
\mathit{FT}\left\{ \nabla\cdot\left[\left(\vk v\cdot\nabla\right)\cdot\vk v\right]\right\}  & =i\vk k\cdot\int\d^{3}q\d^{3}p\delta_{D}(\vk q+\vk p-\vk k)\left(\frac{-i\vk q}{q^{2}}\cdot i\vk p\right)\frac{-i\vk p}{p^{2}}\theta\ppt q\theta\ppt p\\
 & =\vk k\cdot\int\d^{3}q\d^{3}p\delta_{D}(\vk k-\vk q-\vk p)\left(\frac{\vk p\cdot\vk q}{p^{2}q^{2}}\right)\vk p\,\theta\ppt q\theta\ppt p\\
 & =\int\d^{3}q\d^{3}p\delta_{D}(\vk k-\vk q-\vk p)\underbrace{\frac{(\vk p\cdot\vk q)^{2}\vk p\cdot\vk q}{2p^{2}q^{2}}}_{\beta(\vk q,\vk p)}\theta\ppt q\theta\ppt p
\end{align*}
where in the last step we used the symmetry between $\vk p$ and $\vk q$.
The terms marked with an underbrace, are the ones responsible for
the mode-mode coupling:

\begin{equation}
\alpha(\vk q,\vk p)=\frac{(\vk p+\vk q)\cdot\vk q}{q^{2}}=\alpha(-\vk q,-\vk p);\;\beta(\vk q,\vk p)=\frac{(\vk p+\vk q)^{2}\vk p\cdot\vk q}{2p^{2}q^{2}}=\beta(-\vk q,-\vk p)\label{eq:alpha-beta-func}
\end{equation}



\subsubsection{The field notation\label{sub:The-field-notation}}

In the perturbation theory literature \cite{bernardeau_large-scale_2001,crocce_renormalized_2005,pietroni_flowing_2008},
eqns. \ref{eq:continuity}-\ref{eq:poisson} are written in a more
compact way (also called field notation):

\begin{equation}
\partial_{\eta}\varphi_{a}(\vk k,\eta)=-\Omega_{ab}\pkn\varphi_{b}\pkn+e^{\eta}\gamma_{abc}(\vk k,\vk{-p},\vk{-q})\vpa b\ppn p\vpa c\ppn q\label{eq:field notation}
\end{equation}


Where the field doublet is defined as: 
\begin{equation}
\vpa a\pkn=e^{-\eta}\colv{\delta_{m}\pkn}{-\theta\pkn/\curH}\label{eq:field-doublet}
\end{equation}


and we define a new time variable which will prove to be very convenient
in this notation

\[
\eta\equiv\log\frac{a}{a_{in}}
\]


On the l.h.s. of eqn. \ref{eq:field notation} the second term represents
all the nonlinearities and non-localities, if we neglect this term
we go back to linear perturbation theory. The $\gamma_{abc}$ functions
in this formalism can be understood as interaction vertices and its
only non-vanishing components are precisely given by the mode-mode
coupling functions \ref{eq:alpha-beta-func} : 
\begin{align}
\gamma_{121}\pcq kpq & =\frac{1}{2}\delta_{D}\psq kpq\alpha(\vk p,\vk q) & \;\gamma_{121}\pcq kqp=\gamma_{112}\pcq kpq\label{eq:coupling-vertices}\\
\gamma_{222}\pcq kpq & =\delta_{D}\psq kpq\beta(\vk p,\vk q)\nonumber 
\end{align}
in this notation and throughout this work, an integration over $\vk p,\vk q$
is understood and $\vk k$ is always the ``external'' momentum.
The integral signs will be added only when there could be a confusion.

Due to mode-mode coupling, there is a loss of information about the
initial conditions in the limit of high-k, since density perturbations
get mixed \cite{crocce_memory_2006}. This has as a consequence that
highly-nonlinear corrections to the power spectrum become cosmology-independent
in a rough way.

The information about the cosmological background is contained in:
\begin{equation}
\Omega_{ab}\pkn=\begin{pmatrix}1 & -1\\
-\frac{3}{2}\Omega_{m}(\eta)(1+\mathcal{B}\pkn) & 2+\frac{\curH'}{\curH}+\mathcal{A}\pkn
\end{pmatrix}\label{eq:general-Omega-Matrix}
\end{equation}


Where we have the usual definitions: $\curH=aH,\; a\mbox{d}\tau=\mbox{d}t,\; a'=\frac{\mathrm{d}a}{\d\ln a}=a,\;\frac{\curH'}{\curH}=\frac{H'}{H}+1,$
where $':=\frac{\d}{\d\ln a}$ and $N\equiv\ln a$ is what is typically
called the e-foldings time.

For details on how to go back to the usual fluid equations \ref{eq:continuity}-\ref{eq:poisson}
in Fourier space starting from the field equation \ref{eq:field notation},
see Appendix \ref{sec:Appendix-field-equations}.

Equation \ref{eq:field notation} is the starting point for all renormalization
and resummation methods \cite{crocce_renormalized_2005,bernardeau_evolution_2013,bernardeau_constructing_2012,valageas_matter_2013,anselmi_nonlinear_2012,anselmi_next--leading_2010}.
The linear part can be easily solved and the function relating the
initial primordial density perturbations to the final one, is called
the linear propagator and will be studied in section \ref{sub:linear propagator}.
The nonlinear part, cannot be solved exactly analytically, nor numerically.
But a perturbative approach using all tools from Quantum Field Theory
can be used to regularize its divergences which are caused by the
fact that the density perturbations (which is at the same time the
perturbation variable) grows with time and increasing wave vector.
For this part we will use the resummation technique of \cite{anselmi_nonlinear_2012}
and this will be explained in detail in section \ref{sec:The-Evolution-Equation}.

Renormalized perturbation theory (RPT) can help in finding the evolution
of the nonlinear power spectrum at small scales and late times, but
even if we could calculate exactly its result at all loop orders,
there are still intrinsic limitations given by the starting equations
\ref{eq:continuity}-\ref{eq:poisson}. Apart from neglecting vorticity
in the later stages of evolution, the initial equations are derived
in the single-stream-approximation. This means that at a single point
in space, there can be only one velocity direction. This clearly breaks
down in the virialization regime and even before. The RPT approach
can be extended and improved by including these other sources of density
power into the equations in an effective way, see the discussion in
\cite{manzotti_coarse_2014,pietroni_coarse-grained_2011} and recent
results in the effective field theory of large scale structures \cite{baumann_cosmological_2012,pajer_renormalization_2013,senatore_ir-resummed_2014,carrasco_effective_2012}.


\subsection{Solving for the general scale dependent linear propagator \label{sub:linear propagator}}

As was explained above, in eqn. \ref{eq:field notation} the non-linearity
of the Vlasov-Poisson system of equations is fully encoded in the
vertex $\gamma_{abc}$ which represents the mode-mode coupling. Without
this term, we recover the linear equation:

\begin{equation}
\pet\vpa a\pkn=-\Omega_{ab}\pkn\vpa b\pkn\label{eq:2.1}
\end{equation}
which is valid for a fully scale and time dependent $\Omega_{ab}$.

The linear propagator is just the function that connects the initial
density perturbations with the final ones, or in other words solves
the above equation \cite{crocce_renormalized_2005}. If this equation
has solutions of the form \cite{pietroni_flowing_2008}:

\[
\vpa{sol}\pkn=\begin{pmatrix}1\\
f\pkn
\end{pmatrix}\varphi\pkn
\]
then we can find an equation that describes the evolution of the growth
of perturbations.

For the index $a=1$:

\begin{equation}
\pet\varphi=-\Omega_{11}\varphi-\Omega_{12}f\varphi=-(\Omega_{11}+\Omega_{12}f)\varphi\label{eq:linear-phi-eqn}
\end{equation}


For the index $a=2$:

\begin{align}
\pet(f\varphi) & =f\pet\varphi+\varphi\pet f=-\Omega_{21}\varphi-\Omega_{22}f\varphi\nonumber \\
\Rightarrow\pet f & =\Omega_{12}f^{2}+(\Omega_{11}-\Omega_{22})f-\Omega_{21}\label{eq:f-growth-rate}\\
\Rightarrow\pet f & =\Omega_{12}(f-\bar{f}_{+})(f-\bar{f}_{-})\label{eq:fgrowth-factorized-eqn}
\end{align}


Equation \ref{eq:f-growth-rate} is what we usually know as the growth
rate equation for $f=\d\ln D/\d\ln a$, being $D$ the growth factor
of density perturbations and in this general case it can have a time
and scale dependent solution.

The zeros of eqn. \ref{eq:fgrowth-factorized-eqn} are given by:

\begin{equation}
\bar{f}_{\pm}\pkn=\frac{(\Omega_{22}-\Omega_{11})\mp\sqrt{(\Omega_{22}-\Omega_{11})^{2}+4\Omega_{21}\Omega_{12}}}{2\Omega_{12}}\label{eq:2.4}
\end{equation}


The solution of eqns. \ref{eq:linear-phi-eqn} and \ref{eq:fgrowth-factorized-eqn}
is then given by:

\begin{align*}
\varphi(\eta) & =e^{-\int_{\eta'}^{\eta}(\Omega_{11}+\Omega_{12}f)\d x}\varphi(\eta')\\
f(\eta)\varphi(\eta) & =e^{-\int_{\eta'}^{\eta}(\Omega_{21}+\Omega_{22}f)\d x}f(\eta')\varphi(\eta')\\
 & =e^{-\int_{\eta'}^{\eta}(\Omega_{11}+\Omega_{12}f)\d x}\varphi(\eta')f(\eta')\frac{f(\eta)}{f(\eta')}
\end{align*}


One can identify the basis solutions by setting their initial conditions
as:

\[
f_{\pm}^{in}=\bar{f}_{\pm}(\vk k,\eta_{i})
\]
where $\eta_{i}$ is an initial time that can be set at high redshift
where the Universe is approximately Einstein-deSitter (E-dS) or strongly
matter dominated.

For E-dS, $\Omega_{m}=1$ we have very simple background quantities:
$\mathcal{H}'\backslash\mathcal{H}=-1/2-3w_{eff}/2=-1/2$, so that
the $\Omega_{ab}$ from equation \ref{eq:general-Omega-Matrix} is
simply:

\[
\Omega_{ab}=\begin{pmatrix}1 & -1\\
-\frac{3}{2} & \frac{3}{2}
\end{pmatrix}
\]


which gives the following initial conditions for the growing $u$
and decaying $v$ modes:

\[
u_{a}=\begin{pmatrix}1\\
f_{+}^{in}
\end{pmatrix}=\begin{pmatrix}1\\
1
\end{pmatrix}
\]


\[
v_{a}=\begin{pmatrix}1\\
f_{-}^{in}
\end{pmatrix}=\begin{pmatrix}1\\
-\frac{3}{2}
\end{pmatrix}
\]


The growing mode will be the mode of interest that we will use in
section \ref{sec:The-Evolution-Equation}, when we want to calculate
the evolution of the power spectrum.

The instantaneous projectors on the two basis solutions are defined
as:

\begin{align*}
\mathrm{\mathbf{M}}{}^{+}\pkn\begin{pmatrix}1\\
f_{+}\pkn
\end{pmatrix} & =\begin{pmatrix}1\\
f_{+}\pkn
\end{pmatrix}\\
\mathrm{\mathbf{M}}{}^{+}\pkn\begin{pmatrix}1\\
f_{-}\pkn
\end{pmatrix} & =0\\
\mathbf{\mathrm{\mathbf{M}}}^{-}\pkn\begin{pmatrix}1\\
f_{-}\pkn
\end{pmatrix} & =\begin{pmatrix}1\\
f_{-}\pkn
\end{pmatrix}\\
\mathrm{\mathbf{M}}^{-}\pkn\begin{pmatrix}1\\
f_{+}\pkn
\end{pmatrix} & =0
\end{align*}


The growing projector can be written explicitly by subtracting the
decaying projector from the unity matrix:

\[
\mathrm{\mathbf{M}}{}^{+}\pkn=\mathbb{1}-\mathrm{\mathbf{M}}{}^{-}\pkn=\frac{1}{f_{-}-f_{+}}\begin{pmatrix}f_{-} & -1\\
f_{-}f_{+} & -f_{+}
\end{pmatrix}
\]


For the Einstein-deSitter case, the projectors do not evolve in time,
since $u_{a}$ and $v_{a}$ are constant, and they are given by: 
\begin{align*}
\mathrm{\mathbf{M}}{}^{+} & =\frac{1}{5}\begin{pmatrix}3 & 2\\
3 & 2
\end{pmatrix}\\
\mathrm{\mathbf{M}}{}^{-} & =\frac{1}{5}\begin{pmatrix}2 & -2\\
-3 & 3
\end{pmatrix}
\end{align*}


The linear propagator is defined as the operator giving the linear
evolution of the field $\vpa a$, or in other words, solves eqn.\ref{eq:2.1}
:

\[
\vpa a\pkn=g_{ab}(\vk k,\eta,\eta')\vpa b\pkn
\]
and it has to fulfill following properties:

\begin{align*}
\pet g_{ab}(\vk k,\eta,\eta') & =-\Omega_{ac}\pkn\cdot g_{cb}(\vk k,\eta,\eta')\\
\lim_{\eta'\rightarrow\eta}g_{ab}(\vk k,\eta,\eta') & =\mathbb{1}_{ab}\\
g_{ab}(\vk k,\eta,\eta')\cdot g_{bc}(\vk k,\eta',\eta'') & =g_{ac}(\vk k,\eta,\eta'')
\end{align*}


Using these properties and the projectors, the propagator can be written
in general as:

\begin{equation}
\begin{aligned}g(\vk k,\eta,\eta') & =\Theta(\eta-\eta')\left[e^{-\int_{\eta'}^{\eta}(\Omega_{11}+\Omega_{12}f_{+})\d x}\begin{pmatrix}1 & 0\\
0 & \frac{f_{+}\pkn}{f_{+}(\vk k,\eta')}
\end{pmatrix}\mathrm{\mathbf{M}}{}^{+}(\vk k,\eta')\right.\\
 & \left.+\, e^{-\int_{\eta'}^{\eta}(\Omega_{11}+\Omega_{12}f_{-})\d x}\begin{pmatrix}1 & 0\\
0 & \frac{f_{-}\pkn}{f_{-}(\vk k,\eta')}
\end{pmatrix}\mathrm{\mathbf{M}}{}^{-}(\vk k,\eta')\right]
\end{aligned}
\label{eq:general-propagator}
\end{equation}


In the E-dS case, this would reduce to simply (since there is no $k$-dependence
in any quantity and the growing mode is constant):

\[
g(\eta,\eta')=\Theta(\eta-\eta')\left[\frac{1}{5}\begin{pmatrix}3 & 2\\
3 & 2
\end{pmatrix}+\frac{1}{5}\begin{pmatrix}2 & -2\\
-3 & 3
\end{pmatrix}e^{-5/2(\eta-\eta')}\right]
\]


Using the same procedure, we will calculate the linear propagator
for the Horndeski case, in which the growth factor $D$ is now scale
and time dependent. Then the linear propagator can be used to calculate
its fully nonlinear renormalized version, which then is a crucial
ingredient of the evolution equation in section \ref{sec:The-Evolution-Equation}.


\subsection{The linear propagator in the Horndeski case}

Using eqn. \ref{eq:Yfunc} as the modification of the Poisson equation
we can write the general $\Omega_{ab}$ matrix as:

\begin{equation}
\Omega_{ab}\pkn=\left(\begin{array}{cc}
1 & -1\\
-\frac{3\mu(k)\Omega_{m}(\eta)}{2} & \frac{\mathcal{H}'}{\mathcal{H}}+2
\end{array}\right)
\end{equation}
in this case, the initial conditions from eqn.\ref{eq:2.4} are: 
\begin{equation}
\begin{aligned}f_{-}^{in} & =-\frac{1}{2}(\Sigma+\omega)\\
f_{+}^{in} & =\frac{1}{2}(\Sigma-\omega)
\end{aligned}
\end{equation}
where $\omega=1+\frac{\curH'}{\curH}=\frac{1}{2}-\frac{3}{2}w_{eff}$
and $\Sigma=\sqrt{6Y\Omega_{m}+\omega^{2}}$ are quite general functions
of scale and time. Inserting this into eqn.\ref{eq:general-propagator},
one can find the most general form of the propagator for the Horndeski
theory. However, this is not so practical, since we would have to
solve for a scale and time dependent growth rate $f$ and evaluate
the $\mathcal{H}$ function at each step.

For models which are close to $\Lambda\textrm{CDM}$, it is more convenient
to change the time variable from $\eta=\ln\frac{a}{a_{in}}$ to $\mathcal{X}=\ln\frac{D(\tau)}{D(\tau=\tau_{in})}$,
where $D(\tau)$ is the growth function usually written as the growing
solution of the linear density perturbation equation : $\delta_{c}(\tau)=D_{+}(\tau)\delta_{c}^{in}$.
In our case, however, the time variable $\mychi$ would itself be
scale dependent, since the growth rate equation in the Horndeski case
is scale dependent, so that $\mathcal{X}(k)=\ln\frac{D(\tau,k)}{D(\tau=\tau_{in},k)}$.
Using $\frac{\partial}{\partial\eta}=\frac{\d\ln D}{\d\ln a}\frac{\partial}{\partial\ln D}=f\frac{\partial}{\partial\mathcal{X}}$,
we can rewrite eqns.\ref{eq:linear-phi-eqn}-\ref{eq:f-growth-rate}
as (where $':=\frac{\partial}{\partial\mychi}$): 
\begin{align}
f(\vk k,\mychi)\delta'_{c}(\vk k,\mychi)+\frac{\theta(\vk k,\mychi)}{\curH}+\frac{\vk k\cdot\vk q}{q^{2}}\delta_{c}(\vk q,\mychi)\frac{\theta(\vk p,\mychi)}{\curH} & =0\label{eq:fg-rate-1}\\
f(\vk k,\mychi)\frac{\theta(\vk k,\mychi)'}{\curH}+\frac{\theta(\vk k,\mychi)}{\curH}+\frac{1}{2}\frac{\vk k^{2}\vk q\cdot\vk p}{q^{2}p^{2}}\frac{\theta(\vk q,\mychi)}{\curH}\frac{\theta(\vk{p,\mychi})}{\curH} & =-\frac{3}{2}\Omega_{m}(\mychi)\mu(\vk k)\curH^{2}\delta_{c}(\vk k,\mychi)\label{eq:fg-rate-2}
\end{align}



The doublet \ref{eq:field-doublet} can now be redefined as: 
\begin{equation}
\tilde{\varphi}_{a}=\left(\begin{array}{c}
\tilde{\varphi}_{1}\\
\tilde{\varphi}_{2}
\end{array}\right)=\begin{pmatrix}e^{-\mathcal{X}}\delta_{c}\\
-e^{-\mathcal{X}}\frac{\theta}{\curH f}
\end{pmatrix}\label{eq:field-redefinition}
\end{equation}


Substituting in the previous equations the values for $\delta_{c},\;\theta$
and $\delta'_{c}=e^{\mathcal{X}}(\varphi'_{1}+\vpa 1)$, $\theta'=-e^{\mathcal{X}}f(\mathcal{X})\curH\left(\tilde{\varphi}_{2}\left(1+\frac{f'(\mathcal{X})}{f(\mathcal{X})}+\frac{\curH'}{\curH}\right)+\tilde{\varphi}'_{2}\right)$
we get:

\begin{align}
\tilde{\varphi}_{1}'+\tilde{\varphi}_{1}-\tilde{\varphi}_{2}-\alpha e^{\mychi}\tilde{\varphi}_{1}\tilde{\varphi}_{2} & =0\label{eq:varphi1}\\
-\tilde{\varphi}'_{2}-\tilde{\varphi}_{2}(1+\frac{f'}{f}+\frac{1}{f}+\frac{\curH'}{\curH})+\beta e^{\mychi}\tilde{\varphi}_{2}\tilde{\varphi}_{2} & =-\frac{3}{2}\Omega_{m}\mu\frac{\tilde{\varphi}_{1}}{f^{2}}\nonumber \\
\Rightarrow-\tilde{\varphi}'_{2}-\frac{3}{2}\frac{\Omega_{m}\mu}{f^{2}}\tilde{\varphi}_{2}+\frac{3}{2}\frac{\Omega_{m}\mu}{f^{2}}\tilde{\varphi}_{1}+\beta e^{\mychi}\tilde{\varphi}_{2}\tilde{\varphi}_{2} & =0\label{eq:varphi2}
\end{align}
where we have omitted for notational simplicity the momentum and time
dependence. In the last step we used the growth rate equation $\ddot{\delta}_{m}+\dot{\delta}_{m}\left(1+\frac{\dot{\curH}}{\curH}\right)=\frac{3}{2}\Omega_{m}\delta_{m}\mu$,
where in this case an overdot represents a derivative with respect
to $\eta=\ln\frac{a}{a_{in}}$, since the $'$-symbol is now reserved
for the $\mathcal{X}$ time variable.

Comparing eqns. \ref{eq:varphi1}-\ref{eq:varphi2} with \ref{eq:field notation},
we get the following $\Omega$ matrix: 
\begin{equation}
\tilde{\Omega}\pkc=\begin{pmatrix}1 & -1\\
-\frac{3}{2}\frac{\Omega_{m}(\mychi)}{f_{+}^{2}(\mychi)}\mu(k) & \frac{3}{2}\frac{\Omega_{m}(\mychi)}{f_{+}^{2}(\mychi)}\mu(k)
\end{pmatrix}\label{eq:omegamatrix-horn}
\end{equation}


It is of great importance to note that in the Horndeski case, the
quantity $\frac{\Omega_{m}(\mychi)}{f_{+}^{2}(\mychi)}$ cannot be
approximated to $1$ as it is done in LCDM for all times, since in
this case it can have a much greater or lower value during structure
formation, but more importantly it is scale-dependent through the
scale dependence of $\mathcal{X}(k)$. This can be seen clearly in
plot \ref{fig:Omf2-approx}.


\subsection{Assuming a constant $\mu\protect\neq1$ for the 1-loop quantities}

Assuming a constant $\mu$ different from 1 and the approximation
that $\frac{\Omega_{m}(\mychi)}{f_{+}^{2}(\mychi)}=1$ throughout
the history of the Universe (which is valid only for E-dS but turns
out to be a good approximation (much more accurately than 1\%) for
the nonlinear $\Lambda\textrm{CDM}$ power spectrum), we can follow
the steps given above in section \ref{sub:linear propagator} and
obtain the initial growing and decaying modes:

\[
u_{a}=\begin{pmatrix}1\\
1
\end{pmatrix}
\]


\[
v_{a}=\frac{-2}{3Y}\begin{pmatrix}1\\
-\frac{3Y}{2}
\end{pmatrix}
\]
and with this the projectors:

\begin{align*}
\mathrm{\mathbf{M}}{}^{+} & =\frac{1}{2+3Y}\begin{pmatrix}3Y & 2\\
3Y & 2
\end{pmatrix}\\
\mathbf{\mathrm{\mathbf{M}}}^{-} & =\frac{1}{2+3Y}\begin{pmatrix}2 & -2\\
-3Y & 3Y
\end{pmatrix}
\end{align*}


The propagator would then look like:

\begin{equation}
g(\mychi,\mychi')=\Theta(\mychi-\mychi')\left[\frac{1}{2+3Y}\begin{pmatrix}3Y & 2\\
3Y & 2
\end{pmatrix}+\frac{1}{2+3Y}\begin{pmatrix}2 & -2\\
-3Y & 3Y
\end{pmatrix}e^{-\frac{(2+3Y)}{2}(\mychi-\mychi')}\right]\label{eq:ghorn}
\end{equation}


For the rest of this work, eqn. \ref{eq:ghorn} will be the linear
propagator we will use, even if we are treating more general cases
where $\mu(k)$ is an arbitrary function and $\Omega_{m}/f^{2}\neq1$.
This approximation can be justified better in the next section, when
we will see that $g$ only enters in the evolution equation of the
power spectrum inside the integral of the self-energy and mode-coupling
1-loop quantities, which should contribute only sub-dominantly in
the final power spectrum.


\section{The Evolution Equation for the Power Spectrum \label{sec:The-Evolution-Equation}}

We are interested in solving the general scale and time dependent
evolution equation from the resummation method presented in \cite{anselmi_nonlinear_2012}
(eqn. 53):

\begin{align}
\partial_{\mathcal{X}}\tilde{P}_{ab}(k;\mathcal{X}) & =-\tilde{\Omega}_{ac}\pkdc\tilde{P}_{cb}\pkdc-\tilde{\Omega}_{bc}\pkdc\tilde{P}_{ac}\pkdc\label{eq:evolution-eqn-Chi}\\
 & +H_{\mathbf{a}}(k;\mathcal{X},\mathcal{X}_{in})\tilde{P}_{\mathbf{a}b}\pkdc+H_{\mathbf{b}}(k;\mathcal{X},\mathcal{X}_{in})\tilde{P}_{a\mathbf{b}}\pkdc\nonumber \\
 & +\int\d s\left[\tilde{\Phi}_{ad}(k;\mathcal{X},s)G_{bd}^{eik}(k;\mathcal{X},s)+G_{ad}^{eik}(k;\mathcal{X},s)\tilde{\Phi}_{db}(k;\mathcal{X},s)\right]\nonumber 
\end{align}
where $\mathcal{X}=\ln(D(a)/D(a_{in}))$ (notice that in ref. \cite{anselmi_nonlinear_2012},
$\eta$ is the time variable and represents the growth factor). The
first line of this equation corresponds to the linear evolution equation
of the power spectrum already discussed before. The second and third
lines contain the 1PI (one-particle-irreducible) functions, the self-energy
$\Sigma_{ab}$ and the mode-coupling term $\tilde{\Phi}G_{ab}^{AB}$\textbf{
}accounting for the contributions at the large- and small-k limit
at 1-loop order.

\texttt{\textcolor{green}{Massimo: Can you check from eqns. 33-36? }}

If we transform this equation to $\eta=\ln\frac{a}{a_{in}}$, using
the variable transformation $\partial\mathcal{X}/\partial\eta=\frac{\d\ln D(a)}{\d\ln a}=f(\eta)$,
where $f(\eta)\equiv f(N(\eta))$ and the relation between $N$ and
$\eta$ is given by $N=\eta+\ln(a_{in})$, we have to transform also
the power spectrum since the field has been redefined (see \ref{eq:field-redefinition}):

\begin{equation}
\tilde{P}_{ab}=e^{-2\mathcal{X}(\eta)}e^{2\eta}(\delta_{a1}+\frac{1}{f(\eta)}\delta_{a2})(\delta_{b1}+\frac{1}{f(\eta)}\delta_{b2})P_{ab}(\eta)\label{eq:PS-transformation}
\end{equation}
where we can call this transformation $\varXi_{ab}$: 
\[
\tilde{P}_{ab}=\varXi_{ab}P_{ab}(\eta)
\]
and its inverse would be: 
\begin{equation}
\varXi_{ab}^{-1}=e^{2\mathcal{X}(\eta)}e^{-2\eta}(\delta_{a1}+f(\eta)\delta_{a2})(\delta_{b1}+f(\eta)\delta_{b2})
\end{equation}


However, eqn. \ref{eq:evolution-eqn-Chi} is only invariant under
the transformation:

\begin{equation}
\varUpsilon_{ab}(\eta)=f(\eta)\varXi_{ab}^{-1}=f(\eta)e^{2\mathcal{X}(\eta)}e^{-2\eta}(\delta_{a1}+f(\eta)\delta_{a2})(\delta_{b1}+f(\eta)\delta_{b2})
\end{equation}


since we also have to transform the derivatives and the $\Omega_{ab}$
functions. 

Inserting these transformations into eqn. \ref{eq:evolution-eqn-Chi},
and generalizing to the case where the growth rate is k-dependent,
$f(\eta,k),$we obtain:

\begin{align}
\partial_{\mathcal{\eta}}P_{ab}(k;\eta) & =-\Omega_{ac}\pkdn P_{cb}\pkdn-\Omega_{bc}\pkdn P_{ac}\pkdn\label{eq:evolution-eqn-Chi-eta}\\
 & +\left[H_{\mathbf{a}}(k;\mathcal{X}(\eta,k),\mathcal{X}(\eta_{in},k))f(\eta,k)P_{\mathbf{a}b}(k;\eta)\right.\nonumber \\
 & \left.+H_{\mathbf{b}}(k;\mathcal{X}(\eta,k),\mathcal{X}(\eta_{in},k))f(\eta,k)P_{a\mathbf{b}}(k;\eta)\right]\nonumber \\
 & +\varUpsilon_{ab}(\eta,k)\times\int\d s\left[\tilde{\Phi}_{ad}(k;\mathcal{X}(\eta,k),s)G_{bd}^{eik}(k;\mathcal{X}(\eta,k),s)+G_{ad}^{eik}(k;\mathcal{X}(\eta,k),s)\tilde{\Phi}_{db}(k;\mathcal{X}(\eta,k),s)\right]\nonumber 
\end{align}


The quantities such as $H_{\mathbf{a}}(k;\eta,\eta_{in})$ and $\tilde{\Phi}_{ad}(k;\mathcal{\eta},s)$,
shown in eqns \ref{eq:H1}-\ref{eq:PhiTilde_ad}, which are actually
calculated in the $\mathcal{X}$ variable, are now indirectly a function
of $\eta$ through the relation $\mathcal{X}(\eta)=\ln(D(N(\eta))/D(N(\eta_{in})))$.

The evolution equation as it is written in eqn. \ref{eq:evolution-eqn-Chi}
relies on three different assumptions: the power spectrum is well
behaved for $k\rightarrow0$, which is in our cosmology a good assumption,
since it behaves just a power law $k^{n}$; there is a clear separation
of scales between ``hard'' and ``soft'' modes, or in other words,
the eikonal limit is fulfilled. This means that the modes $k$ we
are interesting in are much bigger than the internal coupling modes
$p,q$. The third assumption is of course the single-stream approximation,
which is used in all forms of resummed and renormalized perturbation
theories in cosmology as was explained already in section \ref{sub:The-field-notation}.

In this work we want to solve eqn. \ref{eq:evolution-equation-eta}
for the simple Horndeski models stated above. We will test two apporaches,
first we will include inside the $\Omega_{ac}\pkdn$ functions, the
full scale and time dependence of the parametrized Horndeski models.
These terms will have a dominant effect on the evolution of $P(\vk k$)
and we will calculate the 1-loop integrals using the usual $\Lambda$CDM
model. Since the $H_{\mathbf{a}}(k;\eta,\eta_{in})$ and $\tilde{\Phi}_{ab}(k;\mathcal{\eta},s)$
functions are calculated for a scale-dependent growth factor, we will
have to test if this scale dependence has a big effect on the result.

As a second approach we will calculate the 1PI functions using the
linear Horndeski propagator in the case that $\mu$ is a constant
different from one. Once these integrals are calculated, we can then
solve the evolution equation completely. In this case we have to test
how much a change in $\mu(k)$ affects the result, i.e. if assuming
a constant $\mu$ is a good approximation or not. In the next section
we will show the explicit expressions for these integrals.


\subsection{The 1PI functions in the Horndeski constant $\mu\protect\neq1$ case}

\textcolor{red}{The Horndeski variable is Y for compatibility
with the code for now, but it can be changed to $\mu$ later on.}

Now we give the general expression for for the 1PI functions $\Sigma_{ab}^{(1)}(k;\mychi,\mychi')$
and $\Phi_{ab}^{(1)}(k;\mychi,\mychi')$ computed at 1-loop in eRPT.
The general expression for $\Sigma_{ab}^{(1)}(k;\mychi,\mychi')$
is given by:

\begin{align}
\Sigma_{ab}^{(1)}(k;\mychi,\mychi') & =\nonumber \\
 & 4e^{\mychi+\mychi'}\int\d^{3}q\gamma_{acd}\pcq k{-q}{q-k}u_{c}P^{0}(q)u_{e}\gamma_{feb}\pcq{k-q}q{-k}g_{df}(\mychi,\mychi')
\end{align}
If we insert for $g_{ab}$ the linear propagator from \ref{eq:ghorn}
and the coupling vertices $\gamma_{abc}$ from \ref{eq:coupling-vertices}
we have to perform an the angular integration of $\d^{3}q$, see Appendix
\ref{sec:Self-energy-Terms-in} for the explicit terms.

The $H_{1}(k;\mychi,-\infty)$, $H_{2}(k;\mychi,-\infty)$ functions
are a time integration of the $\Sigma_{ab}^{(1)}(k;\mychi,\mychi')$
quantities in the internal time from minus infinity to the external
time $\eta$:

\begin{align}
H_{1}(k;\mychi,-\infty) & =\int_{-\infty}^{\eta}\d s\Sigma_{1b}^{(1)}(k;\mychi,\mychi')u_{b}\\
H_{2}(k;\mychi,-\infty) & =\int_{-\infty}^{\eta}\d s\Sigma_{2b}^{(1)}(k;\mychi,\mychi')u_{b}
\end{align}


They have the following form after performing the time integration:

\begin{equation}
H_{1Y}(k;\mychi,-\infty)=-\frac{\pi k^{3}e^{2\mychi}}{3(3Y+4)}\int\d r\left[16+3Y\left(3r^{4}-8r^{2}+1\right)-\frac{9Y}{2r}\left(r^{2}-1\right)^{3}\log\left|\frac{1+r}{1-r}\right|\right]P^{0}(kr)\label{eq:H1}
\end{equation}


\begin{equation}
H_{2Y}(k;\mychi,-\infty)=-\frac{\pi k^{3}e^{2\mychi}}{3(3Y+4)}\int\d r\left[-\frac{9Y}{r^{2}}+9r^{2}\mu+4(9Y+4)-\frac{9Y}{2r^{3}}\left(r^{2}-1\right)^{3}\log\left|\frac{1+r}{1-r}\right|\right]P^{0}(kr)\label{eq:H2}
\end{equation}


The third line of the evoution equation \ref{eq:evolution-eqn-Chi}
contains the mode-coupling function, which is obtained by integrating
the counter-term 1-loop quantity:

\begin{align}
\tilde{\Phi}_{ad}^{(1)}(k;\mychi,\mychi') & =2e^{\mychi+\mychi'}\int\d^{3}q\gamma_{acd}(\vk k,-\vk q,\vk p)u_{c}P^{0}(q)u_{d}\\
 & \times u_{e}P^{0}(p)u_{f}\gamma_{bef}(\vk k,-\vk q,\vk p)\label{eq:PhiTilde_ad}
\end{align}
where $\vk p=\vk k-\vk q$, together with the renormalized propagator
from Crocce-Scoccimarro $\bar{G}_{bd}^{L}(k;\eta,s)$:

\begin{equation}
\int\d s\left[\tilde{\Phi}_{ad}(k;\mychi,s)\bar{G}_{bd}^{L}(k;\mychi,s)+\bar{G}_{ad}^{L}(k;\mychi,s)\tilde{\Phi}_{db}(k;\mychi,s)\right]=\tilde{\Phi}G_{ab}^{A}(k;\mychi)+\tilde{\Phi}G_{ab}^{B}(k;\mychi)
\end{equation}


where for all $a,\, b$, the $B$ terms are: 
\begin{equation}
\tilde{\Phi}G_{ab}^{B}(k;\mychi)=u_{a}u_{b}y^{2}\left(\frac{\sqrt{\pi}}{2}\left(2y^{2}+1\right)\text{Erf}(y)+\left(e^{-y^{2}}-2\right)y\right)P^{0}(k)
\end{equation}


The $\tilde{\Phi}G_{ab}^{B}(k;\eta)$ expression has to be switched
off in the small $k$-limit since it contains 2-loop expressions valid
only at large $k$, therefore it has to be ``filtered'' by a momentum-cutoff
function:

\[
\tilde{\Phi}G_{ab}^{A}(k;\eta)+\frac{(k/\bar{k})^{4}}{1+(k/\bar{k})^{4}}\tilde{\Phi}G_{ab}^{B}(k;\eta)
\]


The $\bar{k}$ quantity can be set to a reasonable scale at which
the large scale expression starts to be applicable, usually we can
set here $\bar{k}=0.2h/\mbox{Mpc}$.
The $A$ terms read (a new variable $W=\frac{3}{2}Y$ has been defined
for simplicity):

\begin{align}
\tilde{\Phi}G_{11}^{A} & =y(\Phi_{11}^{(1)}-\Phi_{11}^{(1)})\mathcal{B}(y^{2};W)\\
 & +\frac{\sqrt{\pi}\text{Erf}(y)}{W+1}(\Phi_{11}^{(1)}W+\Phi_{12}^{(1)})\nonumber 
\end{align}


\begin{align}
\tilde{\Phi}G_{12}^{A} & =\frac{y\mathcal{\mathcal{B}}_{12}(y^{2};W)}{(1+W)^{2}(2+W)}(\Phi_{12}^{(1)}-\Phi_{22}^{(1)}-W(\Phi_{11}^{(1)}-\Phi_{12}^{(1)}))\\
 & +\frac{\sqrt{\pi}\text{Erf}(y)}{2(W+1)}(W(\Phi_{11}^{(1)}+\Phi_{12}^{(1)})+\Phi_{12}^{(1)}+\Phi_{22}^{(1)})
\end{align}


\begin{align}
\tilde{\Phi}G_{22}^{A} & =\frac{yW}{(W+1)^{2}}(\Phi_{22}^{(1)}-\Phi_{12}^{(1)})\mathcal{B}(y^{2};W)\\
 & +\frac{\sqrt{\pi}}{(W+1)}\text{Erf}(y)(\Phi_{12}^{(1)}W+\Phi_{22}^{(1)})\nonumber 
\end{align}


and where we have used the combination of generalized Hypergeometric
functions:

\begin{align*}
\mathcal{B}(y^{2};W) & =\,_{2}F_{2}\left(\frac{1}{2},1;\frac{W}{2}+1,\frac{W}{2}+\frac{3}{2};-y^{2}\right)\\
 & +\frac{W+1}{W+2}\,_{2}F_{2}\left(\frac{1}{2},1;\frac{W}{2}+\frac{3}{2},\frac{W}{2}+2;-y^{2}\right)\\
 & -\frac{1}{W+2}\,_{2}F_{2}\left(1,\frac{3}{2};\frac{W}{2}+\frac{3}{2},\frac{W}{2}+2;-y^{2}\right)
\end{align*}


\begin{align*}
\mathcal{B}_{12}(y^{2};W) & =(2+W)\,_{2}F_{2}\left(\frac{1}{2},1;\frac{W}{2}+1,\frac{W}{2}+\frac{3}{2};-y^{2}\right)\\
 & -\,_{2}F_{2}\left(1,\frac{3}{2};\frac{W}{2}+\frac{3}{2},\frac{W}{2}+2;-y^{2}\right)
\end{align*}


Assuming a general scale-dependent function $\mu(k)$ would turn out
impossible an analaytic calculation of the intermediate quantities,
which would render a practical implementation of this method to be
numerically prohibitive. Therefore, using the fact that the $\mu$
function behaves as a step function in $\log k$, having a well defined
minimum and maximum value we can use simply a constant and check its
effect on the 1-loop and 2-loop corrections. Besides, in any viable
model compatible with observations $\mu$ can differ from $1$ by
about 15-20\%. So that we can be sure that the overall effect will
be just a perturbation around the LCDM value and should reduce to
it in the limit $\mu\rightarrow1$.

\textcolor{red}{Issue: }\textcolor{red}{In the LCDM case from
Massimo's paper, all three }$\tilde{\Phi}G_{ab}^{A}$ \textcolor{red}{functions
can be written using the same combination of Hypergeometric Functions.
In this case, this is only possible for }$\tilde{\Phi}G_{11}^{A}$
\textcolor{red}{and} $\tilde{\Phi}G_{22}^{A}$.


\subsection{Method of implementation}

Equation \ref{eq:evolution-equation-eta} is the final and main equation
we want to solve and it represents a differential equation in time,
for each external momentum $k$ that we are interested in. This means
that if we want to compute the power spectrum on a grid with 100 points
in $k$-space, we need to solve 100 times the same differential equation.
That is why parallelism plays an important role here to speed up the
computational calulation.

First we compute the linear growth function for a specific Horndeski
model, using the linear part of \ref{eq:fg-rate-2}. With this we
obtain the growth rate and the growth factor, which are then used
to calculate the loop integrals.

The initial power spectrum is obtained from CAMB and its evaluated
at 100 points in $k$-space. This is used to compute analytically
eqns. \ref{eq:H1}, \ref{eq:H2}. These integrals can be stored as
long as the cosmological parameters are not modified.

Finally we compute the \ref{eq:evolution-eqn-Chi} for each $k$ mode
in parallel, which using 8 cores on a normal machine, takes about
15 seconds until redshift $z=0$.